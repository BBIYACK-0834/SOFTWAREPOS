<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>POS Order Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        .container {
            display: grid;
            grid-template-columns: 2fr 3fr;
            grid-template-rows: auto 1fr auto;
            gap: 10px;
            width: 90%;
            height: 90%;
        }
        .order-summary {
            grid-column: 1 / 2;
            grid-row: 1 / 4;
            border: 2px solid #000;
            padding: 10px;
            background-color: #ffffff;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .order-summary h2 {
            margin-top: 0;
            text-align: center;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .order-item .item-name {
            font-size: 16px;
        }
        .order-item .item-quantity {
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .order-item .item-price {
            font-size: 16px;
        }
        .order-item .item-time {
            font-size: 12px;
            color: gray;
        }
        .order-item button {
            margin: 0 5px;
            padding: 5px;
            background-color: #ccc;
            border: 1px solid #000;
            cursor: pointer;
        }
        .total-price {
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }
        .menu-section {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .menu-section button {
            padding: 20px;
            background-color: #eee;
            border: 1px solid #000;
            cursor: pointer;
        }
        .function-buttons {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .function-buttons button {
            padding: 20px;
            background-color: #ddd;
            border: 1px solid #000;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="order-summary">
        <h2>주문 내역</h2>
        <div id="order-items"></div>
        <div class="total-price" id="total-price">총액: 0원</div>
    </div>

    <div class="menu-section" id="menu-section">
        <!-- 상품 버튼이 동적으로 생성됩니다 -->
    </div>

    <div class="function-buttons">
        <button>서비스</button>
        <button id="cancel-button">취소</button>
        <button id="order-button">주문</button>
    </div>
</div>

<script>
    const orderItemsContainer = document.getElementById('order-items');
    const totalPriceElement = document.getElementById('total-price');
    const tableNumber = new URLSearchParams(window.location.search).get('table');
    const menuSection = document.getElementById('menu-section');
    let orderList = {};
    const timeIntervals = {};

    window.onload = function () {
        const savedOrders = localStorage.getItem(`table-${tableNumber}`);
        if (savedOrders) {
            orderList = JSON.parse(savedOrders);
        }

        fetch(`http://localhost:8080/user/order/${tableNumber}`)
            .then(response => response.json())
            .then(serverOrders => {
                serverOrders.forEach(order => {
                    const itemName = order.prodName;              // 수정됨
                    const itemPrice = order.price || 0;           // 서버에서 prodPri가 없다면 기본값 처리
                    const quantity = order.quantity;

                    orderList[itemName] = {
                        price: itemPrice,
                        quantity: quantity,
                        totalPrice: itemPrice * quantity,
                        time: new Date(order.orderedAt),
                        orderNum: order.orderNum
                    };

                    timeIntervals[itemName] = setInterval(() => {
                        updateOrderSummary();
                    }, 1000);
                });
                updateOrderSummary();
            });


        fetch('http://localhost:8080/admin/products')
            .then(response => response.json())
            .then(products => {
                products.forEach(product => {
                    const button = document.createElement('button');
                    button.setAttribute('data-name', product.prodName);
                    button.setAttribute('data-price', product.prodPri);
                    button.innerHTML = `${product.prodName}<br>${product.prodPri.toLocaleString()}원`;

                    button.addEventListener('click', function () {
                        const itemName = this.getAttribute('data-name');
                        const itemPrice = parseInt(this.getAttribute('data-price'));
                        const orderTime = new Date();

                        if (orderList[itemName]) {
                            orderList[itemName].quantity += 1;
                            orderList[itemName].totalPrice += itemPrice;
                        } else {
                            orderList[itemName] = {
                                price: itemPrice,
                                quantity: 1,
                                totalPrice: itemPrice,
                                time: orderTime
                            };

                            timeIntervals[itemName] = setInterval(() => {
                                updateOrderSummary();
                            }, 1000);
                        }

                        updateOrderSummary();
                    });

                    menuSection.appendChild(button);
                });
            });
    };

    function calculateElapsedTime(orderTime) {
        const now = new Date();
        const elapsedSeconds = Math.floor((now - new Date(orderTime)) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        return `${minutes}분 ${seconds}초`;
    }

    function updateOrderSummary() {
        orderItemsContainer.innerHTML = '';
        let totalPrice = 0;

        Object.keys(orderList).forEach(itemName => {
            const item = orderList[itemName];
            totalPrice += item.totalPrice;

            const orderItem = document.createElement('div');
            orderItem.classList.add('order-item');

            const nameDiv = document.createElement('div');
            nameDiv.classList.add('item-name');
            nameDiv.textContent = itemName;

            const quantityDiv = document.createElement('div');
            quantityDiv.classList.add('item-quantity');

            const minusButton = document.createElement('button');
            minusButton.textContent = '-';
            minusButton.addEventListener('click', () => {
                if (item.quantity > 1) {
                    item.quantity -= 1;
                    item.totalPrice -= item.price;
                } else {
                    delete orderList[itemName];
                    clearInterval(timeIntervals[itemName]);
                }
                updateOrderSummary();
            });

            const plusButton = document.createElement('button');
            plusButton.textContent = '+';
            plusButton.addEventListener('click', () => {
                item.quantity += 1;
                item.totalPrice += item.price;
                updateOrderSummary();
            });

            const quantityText = document.createElement('span');
            quantityText.textContent = `${item.quantity}개`;

            quantityDiv.appendChild(minusButton);
            quantityDiv.appendChild(quantityText);
            quantityDiv.appendChild(plusButton);

            const priceDiv = document.createElement('div');
            priceDiv.classList.add('item-price');
            priceDiv.textContent = `${item.totalPrice.toLocaleString()}원`;

            const timeDiv = document.createElement('div');
            timeDiv.classList.add('item-time');
            timeDiv.textContent = `주문 후 ${calculateElapsedTime(item.time)} 경과`;

            orderItem.appendChild(nameDiv);
            orderItem.appendChild(quantityDiv);
            orderItem.appendChild(priceDiv);
            orderItem.appendChild(timeDiv);

            orderItemsContainer.appendChild(orderItem);
        });

        totalPriceElement.textContent = `총액: ${totalPrice.toLocaleString()}원`;
    }

    document.getElementById('order-button').addEventListener('click', () => {
        fetch(`http://localhost:8080/user/order/${tableNumber}`)
            .then(response => response.json())
            .then(serverOrders => {
                const deletePromises = [];
                const putPromises = [];
                const serverOrderMap = new Map();

                serverOrders.forEach(order => {
                    const name = order.prodName; // ✅ 수정: sales.prodName → prodName
                    const orderNum = order.orderNum;
                    const oldQty = order.quantity;

                    serverOrderMap.set(name, orderNum);

                    if (!orderList[name]) {
                        deletePromises.push(
                            fetch(`http://localhost:8080/admin/${orderNum}`, { method: 'DELETE' })
                        );
                    } else if (orderList[name].quantity !== oldQty) {
                        const updateDto = {
                            prodName: name,
                            quantity: orderList[name].quantity,
                            price: orderList[name].price,
                            tableNumber: parseInt(tableNumber)
                        };

                        putPromises.push(
                            fetch(`http://localhost:8080/admin/${orderNum}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updateDto)
                            })
                        );
                    }

                    delete orderList[name];
                });


                const postPromises = Object.entries(orderList).map(([prodName, item]) => {
                    return fetch(`http://localhost:8080/user/order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prodName,
                            quantity: item.quantity,
                            price: item.price,
                            tableNumber: parseInt(tableNumber)
                        })
                    });
                });

                return Promise.all([...deletePromises, ...putPromises, ...postPromises]);
            })
            .then(() => {
                alert('주문이 완료되었습니다.');
                localStorage.removeItem(`table-${tableNumber}`);
                window.location.href = 'index.html';
            })
            .catch(error => {
                console.error('주문 처리 중 오류:', error);
                alert('주문 처리에 실패했습니다.');
            });
    });

    document.getElementById('cancel-button').addEventListener('click', () => {
        window.location.href = 'index.html';
    });
</script>

</body>
</html>
