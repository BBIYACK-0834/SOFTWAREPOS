<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ÏÇ¨Ïö©Ïûê Ï£ºÎ¨∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 15px 0;
        }

        .menu-container {
            flex: 2;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .menu-grid button {
            padding: 30px;
            font-size: 18px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 8px;
        }

        .menu-grid button:hover {
            background-color: #ddd;
        }

        .order-summary {
            flex: 1;
            background-color: #fff;
            border-top: 2px solid #ccc;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .order-items {
            overflow-y: auto;
            max-height: 150px;
            margin-bottom: 10px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .actions button {
            flex: 1;
            margin: 0 5px;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .actions button:nth-child(1) {
            background-color: #2196F3;
            color: white;
        }

        .actions button:nth-child(2) {
            background-color: #999;
            color: white;
        }

        .actions button:nth-child(3) {
            background-color: #4CAF50;
            color: white;
        }

        #total {
            font-weight: bold;
            text-align: right;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-content h3 {
            text-align: center;
            margin-top: 0;
        }

        .modal-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 16px;
        }

        .close-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            margin-top: 15px;
            cursor: pointer;
            float: right;
        }

        .close-btn:hover {
            background-color: #c62828;
        }
    </style>
</head>
<body>

<header>
    <h1>Î©îÎâ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h1>
</header>

<div class="menu-container">
    <div class="menu-grid" id="menu"></div>
</div>

<div class="order-summary">
    <div class="order-items" id="order-list"></div>
    <div id="total">Ï¥ùÏï°: 0Ïõê</div>
    <div class="actions">
        <button onclick="showCurrentOrders()">ÌòÑÏû¨ Ï£ºÎ¨∏ÎÇ¥Ïó≠</button>
        <button onclick="clearOrder()">Ï¥àÍ∏∞Ìôî</button>
        <button onclick="submitOrder()">Ï£ºÎ¨∏ÌïòÍ∏∞</button>
    </div>
</div>

<div class="modal" id="orderModal">
    <div class="modal-content">
        <h3>ÌòÑÏû¨ Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h3>
        <div id="modalOrderList"></div>

        <hr style="margin: 20px 0;">
        <h3>ÌòÑÏû¨ ÌÖåÏù¥Î∏î Í∏∞Ï§Ä Ï°∞Î¶¨ ÏàúÏÑú</h3>
        <div id="menuRankingList"></div>

        <button class="close-btn" onclick="closeModal()">Îã´Í∏∞</button>
    </div>
</div>

<script>
    const menuEl = document.getElementById('menu');
    const orderListEl = document.getElementById('order-list');
    const totalEl = document.getElementById('total');
    const modalOrderList = document.getElementById('modalOrderList');
    const menuRankingList = document.getElementById('menuRankingList');
    const modal = document.getElementById('orderModal');
    const order = {};

    const urlParams = new URLSearchParams(window.location.search);
    const tableNumber = urlParams.get('table');

    if (!tableNumber) {
        alert("ÌÖåÏù¥Î∏î Î≤àÌò∏Í∞Ä URLÏóê ÏóÜÏäµÎãàÎã§. Ïòà: ?table=1");
        throw new Error("ÌÖåÏù¥Î∏î Î≤àÌò∏ ÏóÜÏùå");
    }

    fetch('http://localhost:8080/admin/products')
        .then(res => res.json())
        .then(products => {
            products.forEach(p => {
                const btn = document.createElement('button');
                btn.innerHTML = `<strong>${p.prodName}</strong><br>${p.prodPri.toLocaleString()}Ïõê`;
                btn.addEventListener('click', () => {
                    if (order[p.prodName]) {
                        order[p.prodName].quantity += 1;
                    } else {
                        order[p.prodName] = {
                            price: p.prodPri,
                            quantity: 1
                        };
                    }
                    updateOrder();
                });
                menuEl.appendChild(btn);
            });
        });

    function updateOrder() {
        orderListEl.innerHTML = '';
        let total = 0;

        for (const [name, item] of Object.entries(order)) {
            const div = document.createElement('div');
            div.className = 'order-item';

            const left = document.createElement('span');
            left.textContent = `${name} x${item.quantity}`;

            const right = document.createElement('span');
            const subtotal = item.price * item.quantity;
            total += subtotal;
            right.textContent = `${subtotal.toLocaleString()}Ïõê`;

            div.appendChild(left);
            div.appendChild(right);
            orderListEl.appendChild(div);
        }

        totalEl.textContent = `Ï¥ùÏï°: ${total.toLocaleString()}Ïõê`;
    }

    function clearOrder() {
        Object.keys(order).forEach(k => delete order[k]);
        updateOrder();
    }

    function submitOrder() {
        const requests = Object.entries(order).map(([prodName, item]) => {
            return fetch('http://localhost:8080/user/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prodName,
                    quantity: item.quantity,
                    price: item.price,
                    tableNumber: parseInt(tableNumber)
                })
            });
        });

        Promise.all(requests)
            .then(() => {
                alert('Ï£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
                clearOrder();
            })
            .catch(err => {
                console.error('Ï£ºÎ¨∏ Ïã§Ìå®:', err);
                alert('Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
    }

    function showCurrentOrders() {
        fetch(`http://localhost:8080/user/order/${tableNumber}`)
            .then(res => res.json())
            .then(data => {
                modalOrderList.innerHTML = '';
                const myMenuNames = [];

                if (data.length === 0) {
                    modalOrderList.innerHTML = "<p>Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>";
                } else {
                    data.forEach(order => {
                        myMenuNames.push(order.prodName);
                        const div = document.createElement('div');
                        div.className = 'modal-item';
                        div.innerHTML = `
                            <span style="flex: 1; text-align: left;">${order.prodName}</span>
                            <span style="flex: 0 0 auto;">x${order.quantity}</span>
                        `;
                        modalOrderList.appendChild(div);
                    });
                }

                fetch('http://localhost:8080/user/order/all')
                    .then(res => res.json())
                    .then(allOrders => {
                        const grouped = {};
                        menuRankingList.innerHTML = '';

                        allOrders.forEach(order => {
                            if (!myMenuNames.includes(order.prodName)) return;
                            if (!grouped[order.prodName]) grouped[order.prodName] = [];
                            grouped[order.prodName].push(order);
                        });

                        Object.entries(grouped).forEach(([prodName, orders]) => {
                            orders.sort((a, b) => new Date(a.orderedAt) - new Date(b.orderedAt));

                            const title = document.createElement('div');
                            title.style = 'font-weight: bold; margin-top: 10px;';
                            title.textContent = `üçΩÔ∏è ${prodName}`;
                            menuRankingList.appendChild(title);

                            orders.forEach((order, index) => {
                                if (String(order.tableNumber) !== String(tableNumber)) return;

                                const div = document.createElement('div');
                                div.style = 'margin-left: 10px; font-size: 14px;';
                                const time = new Date(order.orderedAt).toLocaleTimeString('ko-KR', {
                                    hour: '2-digit', minute: '2-digit'
                                });
                                div.textContent = `${index + 1}Î≤àÏß∏Î°ú Ï°∞Î¶¨Ï§ëÏù¥ÏóêÏöî (${time})`;
                                menuRankingList.appendChild(div);
                            });

                        });

                        modal.style.display = 'flex';
                    });
            });
    }

    function closeModal() {
        modal.style.display = 'none';
    }
</script>

</body>
</html>
